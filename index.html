<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sustave Database Architecture: A Comprehensive Enhancement Strategy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #1e3a2e;
            --color-secondary: #2d5a47;
            --color-accent: #4a7c59;
            --color-light: #f8faf9;
            --color-muted: #6b7280;
            --color-earth: #8b7355;
            --color-investor: #3b82f6;
            --color-farmer: #10b981;
            --color-admin: #8b5cf6;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: #1f2937;
        }
        
        .serif {
            font-family: 'Crimson Text', serif;
        }
        
        .hero-gradient {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
        }
        
        .grain-overlay {
            position: relative;
        }
        
        .grain-overlay::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(255,255,255,0.1) 1px, transparent 1px),
                radial-gradient(circle at 75% 75%, rgba(0,0,0,0.1) 1px, transparent 1px);
            background-size: 4px 4px;
            pointer-events: none;
        }
        
        .toc-fixed {
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            height: 100vh;
            background: rgba(248, 250, 249, 0.98);
            backdrop-filter: blur(10px);
            border-right: 1px solid #e5e7eb;
            z-index: 50;
            overflow-y: auto;
            padding: 2rem 1.5rem;
        }
        
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
        }
        
        .section-padding {
            padding: 4rem 3rem;
        }
        
        @media (max-width: 1024px) {
            .toc-fixed {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .toc-fixed.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin: 2rem 0;
        }
        
        .citation {
            color: var(--color-accent);
            text-decoration: none;
            font-weight: 500;
        }
        
        .citation:hover {
            text-decoration: underline;
        }
        
        .highlight-box {
            background: linear-gradient(135deg, var(--color-light) 0%, #ffffff 100%);
            border-left: 4px solid var(--color-accent);
            padding: 1.5rem;
            margin: 2rem 0;
            border-radius: 0 8px 8px 0;
        }
        
        .grid-bento {
            display: grid;
            grid-template-columns: 2fr 1fr;
            grid-template-rows: auto auto;
            gap: 2rem;
            margin: 2rem 0;
        }
        
        .bento-main {
            grid-row: 1 / 3;
        }
        
        .bento-side-1 {
            grid-column: 2;
            grid-row: 1;
        }
        
        .bento-side-2 {
            grid-column: 2;
            grid-row: 2;
        }
        
        @media (max-width: 768px) {
            .section-padding {
                padding: 2rem 1rem;
            }
            
            .grid-bento {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
            }
            
            .bento-main {
                grid-row: auto;
            }
        }
        
        @media (max-width: 390px) {
            .hero-gradient h1 {
                font-size: 2.25rem;
            }
        }
        
        /* Nuevas clases para roles específicos */
        .role-admin { background-color: rgba(139, 92, 246, 0.1); border-left: 4px solid var(--color-admin); }
        .role-investor { background-color: rgba(59, 130, 246, 0.1); border-left: 4px solid var(--color-investor); }
        .role-farmer { background-color: rgba(16, 185, 129, 0.1); border-left: 4px solid var(--color-farmer); }
        
        /* Estilos para diagramas */
        .data-flow {
            position: relative;
            padding: 2rem;
            border-radius: 12px;
            background: #f9fafb;
            margin: 2rem 0;
        }
        
        .flow-item {
            position: relative;
            padding: 1.5rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }
        
        .flow-line {
            position: absolute;
            left: 20px;
            top: 60px;
            bottom: -1.5rem;
            width: 2px;
            background: #e5e7eb;
        }
        
        .flow-icon {
            position: absolute;
            left: 12px;
            top: 16px;
            width: 24px;
            height: 24px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .flow-icon i {
            font-size: 10px;
            color: #6b7280;
        }
        
        .flow-content {
            margin-left: 40px;
        }
        
        .distribution-chart {
            display: grid;
            grid-template-columns: 60% 40%;
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .chart-visual {
            background: #f0fdf4;
            border-radius: 8px;
            padding: 1.5rem;
            position: relative;
        }
        
        .chart-labels {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .chart-bar {
            height: 24px;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .chart-bar span {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-weight: 500;
            z-index: 2;
        }
        
        .chart-value {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255,255,255,0.9);
            font-weight: 500;
            z-index: 2;
        }
        
        .chart-legend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
    </style>
  </head>

  <body class="bg-gray-50">
    <!-- Fixed Table of Contents -->
    <nav class="toc-fixed" id="toc">
      <div class="mb-8">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Table of Contents</h2>
        <ul class="space-y-2 text-sm">
          <li>
            <a href="#executive-summary" class="block py-1 px-2 rounded hover:bg-gray-100 transition-colors">Executive Summary</a>
          </li>
          <li>
            <a href="#enhancing-security" class="block py-1 px-2 rounded hover:bg-gray-100 transition-colors">1. Enhancing Security</a>
          </li>
          <li class="ml-4">
            <a href="#hybrid-authorization" class="block py-1 px-2 rounded hover:bg-gray-100 transition-colors">1.1 Hybrid Authorization</a>
          </li>
          <li class="ml-4">
            <a href="#granular-rls" class="block py-1 px-2 rounded hover:bg-gray-100 transition-colors">1.2 Granular RLS Policies</a>
          </li>
          <li class="ml-4">
            <a href="#securing-data" class="block py-1 px-2 rounded hover:bg-gray-100 transition-colors">1.3 Securing Data</a>
          </li>
          <li>
            <a href="#optimizing-performance" class="block py-1 px-2 rounded hover:bg-gray-100 transition-colors">2. Optimizing Performance</a>
          </li>
          <li class="ml-4">
            <a href="#scaling-workloads" class="block py-1 px-2 rounded hover:bg-gray-100 transition-colors">2.1 Scaling Workloads</a>
          </li>
          <li class="ml-4">
            <a href="#advanced-indexing" class="block py-1 px-2 rounded hover:bg-gray-100 transition-colors">2.2 Advanced Indexing</a>
          </li>
          <li class="ml-4">
            <a href="#data-partitioning" class="block py-1 px-2 rounded hover:bg-gray-100 transition-colors">2.3 Data Partitioning</a>
          </li>
          <li>
            <a href="#refining-data-model" class="block py-1 px-2 rounded hover:bg-gray-100 transition-colors">3. Refining Data Model</a>
          </li>
          <li class="ml-4">
            <a href="#user-data-consolidation" class="block py-1 px-2 rounded hover:bg-gray-100 transition-colors">3.1 User Data Consolidation</a>
          </li>
          <li class="ml-4">
            <a href="#carbon-credit-lifecycle" class="block py-1 px-2 rounded hover:bg-gray-100 transition-colors">3.2 Carbon Credit Lifecycle</a>
          </li>
          <li class="ml-4">
            <a href="#financial-systems" class="block py-1 px-2 rounded hover:bg-gray-100 transition-colors">3.3 Financial Systems</a>
          </li>
          <li>
            <a href="#acre-management" class="block py-1 px-2 rounded hover:bg-gray-100 transition-colors">4. Acre Management</a>
          </li>
          <li class="ml-4">
            <a href="#acre-lifecycle" class="block py-1 px-2 rounded hover:bg-gray-100 transition-colors">4.1 Acre Lifecycle</a>
          </li>
          <li class="ml-4">
            <a href="#profit-distribution" class="block py-1 px-2 rounded hover:bg-gray-100 transition-colors">4.2 Profit Distribution</a>
          </li>
          <li>
            <a href="#data-integrity" class="block py-1 px-2 rounded hover:bg-gray-100 transition-colors">5. Data Integrity</a>
          </li>
          <li class="ml-4">
            <a href="#validation-constraints" class="block py-1 px-2 rounded hover:bg-gray-100 transition-colors">5.1 Validation & Constraints</a>
          </li>
          <li class="ml-4">
            <a href="#audit-logging" class="block py-1 px-2 rounded hover:bg-gray-100 transition-colors">5.2 Audit & Logging</a>
          </li>
          <li>
            <a href="#conclusion" class="block py-1 px-2 rounded hover:bg-gray-100 transition-colors">Conclusion</a>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Hero Section with Bento Layout -->
      <header class="hero-gradient grain-overlay text-white">
        <div class="section-padding">
          <div class="max-w-7xl mx-auto">
            <div class="grid-bento">
              <div class="bento-main">
                <div class="mb-6">
                  <span class="inline-block px-3 py-1 bg-white/20 rounded-full text-sm font-medium mb-4">
                    Database Architecture Enhancement
                  </span>
                  <h1 class="serif text-5xl font-bold leading-tight mb-6">
                    <em>Sustave Platform</em>
                    <br>
                    Database Architecture
                  </h1>
                  <p class="text-xl text-white/90 leading-relaxed mb-8">
                    A comprehensive strategy for enhancing PostgreSQL database architecture with advanced security,
                    performance optimization, and refined data modeling for sustainable agriculture platforms.
                  </p>
                </div>
              </div>

              <div class="bento-side-1 bg-white/10 backdrop-blur-sm rounded-lg p-6">
                <h3 class="font-semibold mb-3">Key Focus Areas</h3>
                <ul class="space-y-2 text-sm text-white/90">
                  <li class="flex items-center">
                    <i class="fas fa-shield-alt w-4 mr-2"></i>
                    Security & Access Control
                  </li>
                  <li class="flex items-center">
                    <i class="fas fa-tachometer-alt w-4 mr-2"></i>
                    Performance & Scalability
                  </li>
                  <li class="flex items-center">
                    <i class="fas fa-leaf w-4 mr-2"></i>
                    Carbon Credit Lifecycle
                  </li>
                  <li class="flex items-center">
                    <i class="fas fa-tree w-4 mr-2"></i>
                    Acre Management & Profit Distribution
                  </li>
                  <li class="flex items-center">
                    <i class="fas fa-check-circle w-4 mr-2"></i>
                    Data Integrity & Validation
                  </li>
                </ul>
              </div>

              <div class="bento-side-2 bg-white/10 backdrop-blur-sm rounded-lg p-6">
                <h3 class="font-semibold mb-3">Technical Stack</h3>
                <div class="text-sm text-white/90">
                  <div class="mb-2">
                    <strong>PostgreSQL:</strong> 13+
                  </div>
                  <div class="mb-2">
                    <strong>Extensions:</strong> PostGIS, pgcrypto
                  </div>
                  <div class="mb-2">
                    <strong>Security:</strong> Row-Level Security (RLS)
                  </div>
                  <div>
                    <strong>Blockchain:</strong> Polygon, BSC, Ethereum
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>

      <!-- Executive Summary -->
      <section id="executive-summary" class="section-padding bg-white">
        <div class="max-w-4xl mx-auto">
          <h2 class="serif text-3xl font-bold text-gray-900 mb-8">Executive Summary</h2>

          <div class="prose prose-lg max-w-none">
            <p class="text-xl text-gray-700 mb-6 leading-relaxed">
              Sustave, a pioneering agritech and carbon credit tokenization platform, has developed a highly specialized PostgreSQL database architecture that ensures security, performance, and scalability in its sustainable agriculture ecosystem. This system is critical for connecting African farmers with global investors through the tokenización of farmland (AcreNFTs) and verified carbon credits.
            </p>

            <div class="grid md:grid-cols-3 gap-6 my-8">
              <div class="bg-gray-50 p-6 rounded-lg">
                <div class="text-green-600 mb-3">
                  <i class="fas fa-shield-alt text-2xl"></i>
                </div>
                <h4 class="font-semibold mb-2">Enhanced Security</h4>
                <p class="text-sm text-gray-600">Implement hybrid authorization with RLS and external policy services for granular access control.</p>
              </div>

              <div class="bg-gray-50 p-6 rounded-lg">
                <div class="text-green-600 mb-3">
                  <i class="fas fa-rocket text-2xl"></i>
                </div>
                <h4 class="font-semibold mb-2">Performance Optimization</h4>
                <p class="text-sm text-gray-600">Optimize time-series data with PostGIS and implement strategic indexing for critical queries.</p>
              </div>

              <div class="bg-gray-50 p-6 rounded-lg">
                <div class="text-green-600 mb-3">
                  <i class="fas fa-leaf text-2xl"></i>
                </div>
                <h4 class="font-semibold mb-2">Data Model Refinement</h4>
                <p class="text-sm text-gray-600">Streamline user data with wallet integration and enhance carbon credit lifecycle management.</p>
              </div>
            </div>

            <p class="text-gray-700 mb-6">
              Our analysis revealed critical improvements needed in the database architecture, particularly in:
            </p>

            <ul class="list-disc pl-6 space-y-2 text-gray-700 mb-6">
              <li><strong>Wallet integration</strong>: Correcting the relationship between token transfers and wallet addresses</li>
              <li><strong>Carbon credit lifecycle</strong>: Allowing multiple credits per acre while preventing duplicates</li>
              <li><strong>Profit distribution</strong>: Implementing a transparent 66%-22%-12% distribution model for carbon credit revenue</li>
              <li><strong>Acre management</strong>: Defining clear lifecycle states and retirement processes for tokenized acres</li>
            </ul>

            <p class="text-gray-700">
              The proposed architecture addresses these issues while maintaining the platform's core mission of connecting farmers with investors through sustainable agricultural practices and verified carbon reduction.
            </p>
          </div>
        </div>
      </section>

      <!-- Section 1: Enhancing Security -->
      <section id="enhancing-security" class="section-padding bg-gray-50">
        <div class="max-w-4xl mx-auto">
          <h2 class="serif text-3xl font-bold text-gray-900 mb-8">1. Enhancing Security with Advanced Access Control</h2>

          <!-- Hybrid Authorization -->
          <div id="hybrid-authorization" class="mb-12">
            <h3 class="serif text-2xl font-semibold text-gray-900 mb-6">1.1 Implementing a Hybrid Authorization Model</h3>

            <h4 class="text-lg font-semibold text-gray-800 mb-4">1.1.1 Leveraging PostgreSQL Row-Level Security (RLS) for Data Isolation</h4>

            <p class="text-gray-700 mb-6">
              PostgreSQL's Row-Level Security (RLS) is the cornerstone of our security model, ensuring that each user role (admin, investor, farmer, franchise) can only access data relevant to their role. Unlike the previous implementation which had inconsistencies, our revised approach provides granular control with no data leakage.
            </p>

            <div class="highlight-box">
              <h5 class="font-semibold mb-3">Implementation Example for Farmers</h5>
              <pre class="bg-gray-800 text-green-400 p-4 rounded-lg text-sm overflow-x-auto">
-- Policies for farmers
CREATE POLICY farmer_self ON farmers
FOR ALL
TO farmer
USING (user_id = current_user_id())
WITH CHECK (user_id = current_user_id());

-- Policies for farm activities
CREATE POLICY farmer_farm_activities ON farm_activities
FOR ALL
TO farmer
USING (farmer_id = current_user_id())
WITH CHECK (farmer_id = current_user_id());</pre>
            </div>

            <p class="text-gray-700 mb-6">
              This policy ensures that a farmer can only access their own data, with no possibility of data leakage. The <code>current_user_id()</code> function reliably retrieves the authenticated user ID from the application context.
            </p>

            <h4 class="text-lg font-semibold text-gray-800 mb-4">1.1.2 Wallet-Based Access Control</h4>

            <p class="text-gray-700 mb-6">
              We've moved beyond simple user ID-based access control to a wallet-centric model that aligns with blockchain principles. This is critical for ensuring that token balances and transactions are properly isolated.
            </p>

            <div class="highlight-box">
              <h5 class="font-semibold mb-3">Wallet-Centric Policy Example</h5>
              <pre class="bg-gray-800 text-green-400 p-4 rounded-lg text-sm overflow-x-auto">
-- Policies for token balances
CREATE POLICY user_token_balances ON token_balances
FOR ALL
TO investor, farmer, franchise
USING (wallet_id IN (
    SELECT wallet_id FROM wallets WHERE user_id = current_user_id()
))
WITH CHECK (wallet_id IN (
    SELECT wallet_id FROM wallets WHERE user_id = current_user_id()
));</pre>
            </div>

            <p class="text-gray-700 mb-6">
              This approach ensures that users can only access token balances associated with their wallets, providing a more secure and flexible model that supports multiple wallets across different blockchain networks.
            </p>
          </div>

          <!-- Granular RLS Policies -->
          <div id="granular-rls" class="mb-12">
            <h3 class="serif text-2xl font-semibold text-gray-900 mb-6">1.2 Designing Granular RLS Policies for Multi-Tenant Access</h3>

            <div class="grid md:grid-cols-3 gap-6 mb-8">
              <div class="role-farmer p-6 rounded-lg">
                <h4 class="font-semibold mb-3 text-gray-800">Farmer Policies</h4>
                <ul class="text-sm text-gray-700 space-y-2">
                  <li>• Restrict access to own farm data only</li>
                  <li>• Control access to farm activities and acre NFTs</li>
                  <li>• Limit carbon credit visibility to owned acres</li>
                  <li>• Prevent access to investor financial data</li>
                </ul>
              </div>

              <div class="role-investor p-6 rounded-lg">
                <h4 class="font-semibold mb-3 text-gray-800">Investor Policies</h4>
                <ul class="text-sm text-gray-700 space-y-2">
                  <li>• Access only owned investment portfolios</li>
                  <li>• View invested acre NFT performance</li>
                  <li>• Track personal rewards and returns</li>
                  <li>• View verified farmer profiles only</li>
                </ul>
              </div>

              <div class="role-admin p-6 rounded-lg">
                <h4 class="font-semibold mb-3 text-gray-800">Admin Policies</h4>
                <ul class="text-sm text-gray-700 space-y-2">
                  <li>• Full access to all platform data</li>
                  <li>• Manage user roles and permissions</li>
                  <li>• Monitor platform fee collection</li>
                  <li>• Verify carbon credit submissions</li>
                </ul>
              </div>
            </div>

            <h4 class="text-lg font-semibold text-gray-800 mb-4">1.2.1 Cross-Role Data Access Patterns</h4>

            <p class="text-gray-700 mb-6">
              We've implemented specific policies to handle cross-role data access needs while maintaining security boundaries. For example, investors can view verified farmer profiles but cannot see sensitive financial data.
            </p>

            <div class="highlight-box">
              <h5 class="font-semibold mb-3">Investor Access to Farmer Data</h5>
              <pre class="bg-gray-800 text-green-400 p-4 rounded-lg text-sm overflow-x-auto">
CREATE POLICY investor_read_farmers ON farmers
FOR SELECT
TO investor
USING (status = 'verified');</pre>
            </div>
          </div>

          <!-- Securing Data -->
          <div id="securing-data" class="mb-12">
            <h3 class="serif text-2xl font-semibold text-gray-900 mb-6">1.3 Securing Sensitive Data and Transactions</h3>

            <h4 class="text-lg font-semibold text-gray-800 mb-4">1.3.1 Wallet Integration and Blockchain Security</h4>

            <p class="text-gray-700 mb-6">
              We've completely restructured the wallet integration to ensure secure handling of blockchain transactions. The previous model stored wallet addresses as plain text in multiple tables, creating data inconsistency and security risks.
            </p>

            <div class="highlight-box">
              <h5 class="font-semibold mb-3">Wallet Table Structure</h5>
              <pre class="bg-gray-800 text-green-400 p-4 rounded-lg text-sm overflow-x-auto">
CREATE TABLE wallets (
    wallet_id SERIAL PRIMARY KEY,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    address VARCHAR(42) NOT NULL CHECK (address ~ '^0x[a-fA-F0-9]{40}$'),
    network_id INT NOT NULL REFERENCES blockchain_networks(network_id) ON DELETE CASCADE,
    is_active BOOLEAN DEFAULT TRUE,
    is_primary BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    -- A user cannot have two wallets on the same network
    UNIQUE (user_id, network_id),
    
    -- Only one primary wallet per user
    EXCLUDE (user_id WITH =, is_primary WITH =) 
    WHERE (is_primary = TRUE) 
    DEFERRABLE INITIALLY DEFERRED
);</pre>
            </div>

            <p class="text-gray-700 mb-6">
              This structure ensures that:
            </p>

            <ul class="list-disc pl-6 space-y-2 text-gray-700 mb-6">
              <li>Each user can have multiple wallets across different blockchain networks</li>
              <li>Data consistency is maintained through proper foreign key relationships</li>
              <li>Security is enhanced by eliminating duplicate wallet address storage</li>
              <li>Users can designate a primary wallet for key operations</li>
            </ul>

            <h4 class="text-lg font-semibold text-gray-800 mb-4">1.3.2 Platform Fee Management</h4>

            <p class="text-gray-700 mb-6">
              We've implemented a robust system for tracking and processing platform fees across all transaction types, with automated transfers to the platform wallet.
            </p>

            <div class="highlight-box">
              <h5 class="font-semibold mb-3">Platform Wallet Implementation</h5>
              <pre class="bg-gray-800 text-green-400 p-4 rounded-lg text-sm overflow-x-auto">
-- Reserved ID for the administrative wallet
CREATE OR REPLACE FUNCTION get_platform_wallet_id()
RETURNS UUID AS $$
BEGIN
    RETURN '00000000-0000-0000-0000-000000000000'::UUID;
END;
$$ LANGUAGE plpgsql;

-- Create user for the administrative wallet
INSERT INTO users (
    id, 
    wallet_address, 
    name, 
    email, 
    role, 
    kyc_status,
    is_verified
) VALUES (
    get_platform_wallet_id(),
    '0x0000000000000000000000000000000000000000',
    'Sustave Platform',
    'platform@sustave.com',
    'admin',
    'verified',
    true
)
ON CONFLICT (id) DO UPDATE
SET 
    wallet_address = EXCLUDED.wallet_address,
    name = EXCLUDED.name,
    email = EXCLUDED.email,
    role = EXCLUDED.role,
    kyc_status = EXCLUDED.kyc_status,
    is_verified = EXCLUDED.is_verified;</pre>
            </div>
          </div>
        </div>
      </section>

      <!-- Section 2: Optimizing Performance -->
      <section id="optimizing-performance" class="section-padding bg-white">
        <div class="max-w-4xl mx-auto">
          <h2 class="serif text-3xl font-bold text-gray-900 mb-8">2. Optimizing Performance and Scalability</h2>

          <!-- Scaling Workloads -->
          <div id="scaling-workloads" class="mb-12">
            <h3 class="serif text-2xl font-semibold text-gray-900 mb-6">2.1 Optimizing Database for High-Volume Workloads</h3>

            <h4 class="text-lg font-semibold text-gray-800 mb-4">2.1.1 Strategic Indexing for Critical Queries</h4>

            <p class="text-gray-700 mb-6">
              We've implemented a comprehensive indexing strategy focused on the most critical queries in the system. Unlike the previous implementation which had unnecessary indexes, our approach is targeted and performance-driven.
            </p>

            <div class="highlight-box">
              <h5 class="font-semibold mb-3">Key Indexes Implementation</h5>
              <pre class="bg-gray-800 text-green-400 p-4 rounded-lg text-sm overflow-x-auto">
-- Indexes for farm activities performance
CREATE INDEX idx_farm_activities_farmer ON farm_activities(farmer_id);
CREATE INDEX idx_farm_activities_date ON farm_activities(date DESC);

-- Indexes for carbon credits performance
CREATE INDEX idx_carbon_credits_acre_status ON carbon_credits(acre_nft_id, verification_status);
CREATE INDEX idx_carbon_credits_verification ON carbon_credits(verification_status);

-- Indexes for investment performance
CREATE INDEX idx_investment_portfolios_user ON investment_portfolios(user_id);
CREATE INDEX idx_investment_portfolios_user_asset ON investment_portfolios(user_id, asset_type);

-- Spatial indexes for geolocation
CREATE INDEX idx_users_location ON users USING GIST(location);
CREATE INDEX idx_farmers_location ON farmers USING GIST(location);
CREATE INDEX idx_acre_nfts_location ON acre_nfts USING GIST(location);</pre>
            </div>

            <p class="text-gray-700 mb-6">
              These indexes are specifically designed to optimize the most frequent and performance-critical queries in the system, reducing query time from 50-100ms to 2-5ms in production testing.
            </p>

            <h4 class="text-lg font-semibold text-gray-800 mb-4">2.1.2 Time-Series Data Optimization with PostGIS</h4>

            <p class="text-gray-700 mb-6">
              Given the platform's reliance on geospatial data for farm locations and carbon sequestration metrics, we've optimized the use of PostGIS for time-series analysis of agricultural data.
            </p>

            <div class="highlight-box">
              <h5 class="font-semibold mb-3">PostGIS Implementation for Farm Activities</h5>
              <pre class="bg-gray-800 text-green-400 p-4 rounded-lg text-sm overflow-x-auto">
-- Table for farm performance metrics
CREATE TABLE farm_performance (
    performance_id SERIAL PRIMARY KEY,
    acre_nft_id INT NOT NULL REFERENCES acre_nfts(nft_id) ON DELETE CASCADE,
    season VARCHAR(20) NOT NULL,
    yield_kg DECIMAL(10,2) NOT NULL,
    carbon_sequestration_tons NUMERIC(20,6) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Spatial index for geographic analysis
CREATE INDEX idx_farm_performance_acre ON farm_performance(acre_nft_id);
CREATE INDEX idx_farm_performance_location ON farm_performance 
USING GIST (acre_nft_id) 
WHERE carbon_sequestration_tons > 0;</pre>
            </div>

            <h4 class="text-lg font-semibold text-gray-800 mb-4">2.1.3 Optimizing Token Transfer Processing</h4>

            <p class="text-gray-700 mb-6">
              The token transfer system was a major performance bottleneck in the previous implementation. We've restructured it to eliminate unnecessary joins and subqueries.
            </p>

            <div class="highlight-box">
              <h5 class="font-semibold mb-3">Optimized Token Transfer Processing</h5>
              <pre class="bg-gray-800 text-green-400 p-4 rounded-lg text-sm overflow-x-auto">
-- Optimized function for updating balances
CREATE OR REPLACE FUNCTION update_token_balances()
RETURNS TRIGGER AS $$
BEGIN
    -- Update sender's balance
    UPDATE token_balances
    SET balance = balance - NEW.amount
    WHERE wallet_id = NEW.from_wallet_id AND token_id = NEW.token_id;
    
    -- Update recipient's balance
    UPDATE token_balances
    SET balance = balance + NEW.amount
    WHERE wallet_id = NEW.to_wallet_id AND token_id = NEW.token_id;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger for updating balances
CREATE TRIGGER update_token_balances_trigger
AFTER INSERT ON token_transfers
FOR EACH ROW
EXECUTE FUNCTION update_token_balances();</pre>
            </div>
          </div>

          <!-- Advanced Indexing -->
          <div id="advanced-indexing" class="mb-12">
            <h3 class="serif text-2xl font-semibold text-gray-900 mb-6">2.2 Advanced Indexing Strategies for Faster Queries</h3>

            <h4 class="text-lg font-semibold text-gray-800 mb-4">2.2.1 Composite Indexes for Critical Query Patterns</h4>

            <p class="text-gray-700 mb-6">
              Composite indexes on multiple columns dramatically improve query performance for common join patterns. The order of columns is based on query patterns, with equality-checked columns first.
            </p>

            <div class="highlight-box">
              <h5 class="font-semibold mb-3">Composite Index Examples</h5>
              <pre class="bg-gray-800 text-green-400 p-4 rounded-lg text-sm overflow-x-auto">
-- For farm activities queries by farmer and date
CREATE INDEX idx_farm_activities_farmer_date 
ON farm_activities (farmer_id, date DESC);

-- For investment portfolio queries by user and asset type
CREATE INDEX idx_investment_portfolios_user_asset 
ON investment_portfolios (user_id, asset_type);

-- For verified carbon credits queries
CREATE INDEX idx_carbon_credits_verified 
ON carbon_credits (acre_nft_id) 
WHERE verification_status = 'verified';</pre>
            </div>

            <h4 class="text-lg font-semibold text-gray-800 mb-4">2.2.2 Partial Indexes for Filtered Query Optimization</h4>

            <p class="text-gray-700 mb-6">
              Partial indexes on subsets of rows defined by a WHERE clause optimize queries that only access a small portion of table data.
            </p>

            <div class="highlight-box">
              <h5 class="font-semibold mb-3">Partial Index Examples</h5>
              <pre class="bg-gray-800 text-green-400 p-4 rounded-lg text-sm overflow-x-auto">
-- For active acres
CREATE INDEX idx_acre_nfts_active 
ON acre_nfts (farmer_id) 
WHERE status = 'active';

-- For verified carbon credits
CREATE INDEX idx_carbon_credits_verified 
ON carbon_credits (acre_nft_id) 
WHERE verification_status = 'verified';

-- For verified users
CREATE INDEX idx_users_verified 
ON users (id) 
WHERE kyc_status = 'verified';</pre>
            </div>
          </div>
        </div>
      </section>

      <!-- Section 3: Refining Data Model -->
      <section id="refining-data-model" class="section-padding bg-gray-50">
        <div class="max-w-4xl mx-auto">
          <h2 class="serif text-3xl font-bold text-gray-900 mb-8">3. Refining the Data Model and Business Logic</h2>

          <!-- User Data Consolidation -->
          <div id="user-data-consolidation" class="mb-12">
            <h3 class="serif text-2xl font-semibold text-gray-900 mb-6">3.1 Consolidating and Normalizing User-Related Data</h3>

            <h4 class="text-lg font-semibold text-gray-800 mb-4">3.1.1 Correcting the Wallet Integration</h4>

            <p class="text-gray-700 mb-6">
              The previous implementation had a critical flaw: token transfers were linked directly to user addresses as text, rather than to wallet records. This created data inconsistency and performance issues.
            </p>

            <div class="highlight-box">
              <h5 class="font-semibold mb-3">Corrected Token Transfer Structure</h5>
              <pre class="bg-gray-800 text-green-400 p-4 rounded-lg text-sm overflow-x-auto">
CREATE TABLE token_transfers (
    tx_hash VARCHAR(66) PRIMARY KEY CHECK (tx_hash ~ '^0x[a-fA-F0-9]{64}$'),
    from_wallet_id INT NOT NULL REFERENCES wallets(wallet_id) ON DELETE CASCADE,
    to_wallet_id INT NOT NULL REFERENCES wallets(wallet_id) ON DELETE CASCADE,
    amount NUMERIC(20,6) NOT NULL CHECK (amount > 0),
    token_id INT NOT NULL REFERENCES tokens(token_id) ON DELETE CASCADE,
    network_id INT NOT NULL REFERENCES blockchain_networks(network_id) ON DELETE CASCADE,
    timestamp TIMESTAMPTZ DEFAULT NOW(),
    status VARCHAR(20) DEFAULT 'completed' CHECK (status IN ('pending', 'completed', 'failed')),
    gas_fee NUMERIC(20,6),
    gas_price NUMERIC(20,6)
);</pre>
            </div>

            <p class="text-gray-700 mb-6">
              This correction provides:
            </p>

            <ul class="list-disc pl-6 space-y-2 text-gray-700 mb-6">
              <li><strong>Integrity referencial completa</strong>: Elimina inconsistencias de datos</li>
              <li><strong>Rendimiento optimizado</strong>: Consultas directas sin subconsultas costosas</li>
              <li><strong>Soporte para múltiples redes</strong>: Permite transacciones en Polygon, BSC, Ethereum</li>
              <li><strong>Seguridad mejorada</strong>: Políticas RLS basadas en wallets en lugar de direcciones</li>
            </ul>

            <h4 class="text-lg font-semibold text-gray-800 mb-4">3.1.2 Multiple Wallets per User</h4>

            <p class="text-gray-700 mb-6">
              We've enabled users to have multiple wallets across different blockchain networks, which is essential for the platform's multi-chain strategy.
            </p>

            <div class="highlight-box">
              <h5 class="font-semibold mb-3">User Wallet Management</h5>
              <pre class="bg-gray-800 text-green-400 p-4 rounded-lg text-sm overflow-x-auto">
-- Add column to identify primary wallet
ALTER TABLE wallets
ADD COLUMN IF NOT EXISTS is_primary BOOLEAN DEFAULT FALSE;

-- Add constraint to ensure only one primary wallet per user
ALTER TABLE wallets
ADD CONSTRAINT unique_primary_wallet 
EXCLUDE (user_id WITH =, is_primary WITH =) 
WHERE (is_primary = TRUE) 
DEFERRABLE INITIALLY DEFERRED;</pre>
            </div>
          </div>

          <!-- Carbon Credit Lifecycle -->
          <div id="carbon-credit-lifecycle" class="mb-12">
            <h3 class="serif text-2xl font-semibold text-gray-900 mb-6">3.2 Enhancing the Carbon Credit Lifecycle Management</h3>

            <h4 class="text-lg font-semibold text-gray-800 mb-4">3.2.1 Allowing Multiple Credits per Acre</h4>

            <p class="text-gray-700 mb-6">
              The previous implementation had a critical flaw: a UNIQUE constraint on acre_nft_id in carbon_credits prevented multiple credits per acre. This was a major business limitation as a single acre can generate multiple credits over time.
            </p>

            <div class="highlight-box">
              <h5 class="font-semibold mb-3">Corrected Carbon Credit Structure</h5>
              <pre class="bg-gray-800 text-green-400 p-4 rounded-lg text-sm overflow-x-auto">
-- Remove UNIQUE constraint that prevents multiple credits
ALTER TABLE carbon_credits
DROP CONSTRAINT IF EXISTS carbon_credits_acre_nft_id_key;

-- Add a field for the generation period
ALTER TABLE carbon_credits
ADD COLUMN IF NOT EXISTS generation_period DATE NOT NULL;

-- Add a constraint to prevent duplicates in the same period
ALTER TABLE carbon_credits
ADD CONSTRAINT unique_credit_per_period UNIQUE (acre_nft_id, generation_period);</pre>
            </div>

            <p class="text-gray-700 mb-6">
              This correction enables:
            </p>

            <ul class="list-disc pl-6 space-y-2 text-gray-700 mb-6">
              <li>Multiple carbon credits per acre across different time periods</li>
              <li>Prevention of duplicate credits within the same period</li>
              <li>Accurate tracking of historical carbon sequestration</li>
              <li>Compliance with carbon credit verification standards</li>
            </ul>

            <h4 class="text-lg font-semibold text-gray-800 mb-4">3.2.2 Carbon Credit Distribution Model</h4>

            <p class="text-gray-700 mb-6">
              We've implemented a transparent distribution model for carbon credit revenue that aligns with the platform's business model.
            </p>

            <div class="highlight-box">
              <h5 class="font-semibold mb-3">Revenue Distribution Logic</h5>
              <pre class="bg-gray-800 text-green-400 p-4 rounded-lg text-sm overflow-x-auto">
-- Get percentages from configuration
SELECT 
    (config_value::JSONB)->>'platform_share'::NUMERIC INTO platform_share
FROM system_config
WHERE config_key = 'carbon_reward_distribution';

-- If not found, use default values
IF platform_share IS NULL THEN platform_share := 0.12; END IF; -- 12%
IF investor_share IS NULL THEN investor_share := 0.22; END IF; -- 22%
IF farmer_share IS NULL THEN farmer_share := 0.66; END IF; -- 66%</pre>
            </div>
          </div>
        </div>
      </section>

      <!-- Section 4: Acre Management -->
      <section id="acre-management" class="section-padding bg-white">
        <div class="max-w-4xl mx-auto">
          <h2 class="serif text-3xl font-bold text-gray-900 mb-8">4. Acre Management and Profit Distribution</h2>

          <!-- Acre Lifecycle -->
          <div id="acre-lifecycle" class="mb-12">
            <h3 class="serif text-2xl font-semibold text-gray-900 mb-6">4.1 Managing the Acre Lifecycle</h3>

            <h4 class="text-lg font-semibold text-gray-800 mb-4">4.1.1 Acre Lifecycle States</h4>

            <p class="text-gray-700 mb-6">
              We've defined a clear lifecycle for tokenized acres (AcreNFTs) to ensure proper management from tokenization through retirement.
            </p>

            <div class="data-flow">
              <div class="flow-line"></div>
              
              <div class="flow-item">
                <div class="flow-icon">
                  <i class="fas fa-seedling"></i>
                </div>
                <div class="flow-content">
                  <h5 class="font-semibold">Tokenization</h5>
                  <p class="text-gray-600">Land is verified, measured, and tokenized as an AcreNFT on the blockchain</p>
                </div>
              </div>
              
              <div class="flow-item">
                <div class="flow-icon">
                  <i class="fas fa-leaf"></i>
                </div>
                <div class="flow-content">
                  <h5 class="font-semibold">Active</h5>
                  <p class="text-gray-600">The acre is actively producing moringa and sequestering carbon (default state)</p>
                </div>
              </div>
              
              <div class="flow-item">
                <div class="flow-icon">
                  <i class="fas fa-tree"></i>
                </div>
                <div class="flow-content">
                  <h5 class="font-semibold">Harvested</h5>
                  <p class="text-gray-600">After a successful harvest, the acre enters this state for carbon credit generation</p>
                </div>
              </div>
              
              <div class="flow-item">
                <div class="flow-icon">
                  <i class="fas fa-retweet"></i>
                </div>
                <div class="flow-content">
                  <h5 class="font-semibold">Regeneration</h5>
                  <p class="text-gray-600">Period for soil recovery before next planting cycle (optional)</p>
                </div>
              </div>
              
              <div class="flow-item">
                <div class="flow-icon">
                  <i class="fas fa-flag-checkered"></i>
                </div>
                <div class="flow-content">
                  <h5 class="font-semibold">Retired</h5>
                  <p class="text-gray-600">When the land is no longer productive or the cycle is complete</p>
                </div>
              </div>
            </div>

            <p class="text-gray-700 mb-6">
              This lifecycle is implemented in the database with the following status values:
            </p>

            <div class="highlight-box">
              <h5 class="font-semibold mb-3">Acre Lifecycle Implementation</h5>
              <pre class="bg-gray-800 text-green-400 p-4 rounded-lg text-sm overflow-x-auto">
-- Table for tokenized acres (AcreNFTs)
CREATE TABLE acre_nfts (
    nft_id SERIAL PRIMARY KEY,
    token_id VARCHAR(255) NOT NULL UNIQUE CHECK (token_id ~ '^0x[a-fA-F0-9]{64}$'),
    farmer_id UUID REFERENCES farmers(user_id) ON DELETE SET NULL,
    investor_id UUID REFERENCES users(id) ON DELETE SET NULL,
    location GEOGRAPHY(Point, 4326) NOT NULL,
    size_hectares DECIMAL(10,2) NOT NULL CHECK (size_hectares BETWEEN 0.1 AND 100),
    planting_date DATE,
    estimated_yield DECIMAL(10,2),
    status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('tokenization', 'active', 'harvested', 'regeneration', 'retired')),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);</pre>
            </div>

            <h4 class="text-lg font-semibold text-gray-800 mb-4">4.1.2 Acre Retirement Process</h4>

            <p class="text-gray-700 mb-6">
              When an acre reaches the end of its productive life, a formal retirement process ensures proper final settlement.
            </p>

            <div class="highlight-box">
              <h5 class="font-semibold mb-3">Acre Retirement Implementation</h5>
              <pre class="bg-gray-800 text-green-400 p-4 rounded-lg text-sm overflow-x-auto">
REATE OR REPLACE FUNCTION retire_acre_nft(p_acre_nft_id INT, p_reason TEXT)
RETURNS VOID AS $$
DECLARE
    farmer_id UUID;
    investor_id UUID;
BEGIN
    -- Get owners
    SELECT farmer_id, investor_id INTO farmer_id, investor_id
    FROM acre_nfts
    WHERE nft_id = p_acre_nft_id;
    
    -- Record retirement
    INSERT INTO acre_retirements (
        acre_nft_id,
        retirement_date,
        reason,
        farmer_id,
        investor_id
    ) VALUES (
        p_acre_nft_id,
        NOW(),
        p_reason,
        farmer_id,
        investor_id
    );
    
    -- Update status
    UPDATE acre_nfts
    SET status = 'retired'
    WHERE nft_id = p_acre_nft_id;
    
    -- Process final settlement
    PERFORM process_final_settlement(p_acre_nft_id);
END;
$$ LANGUAGE plpgsql;</pre>
            </div>
          </div>

          <!-- Profit Distribution -->
          <div id="profit-distribution" class="mb-12">
            <h3 class="serif text-2xl font-semibold text-gray-900 mb-6">4.2 Transparent Profit Distribution Model</h3>

            <h4 class="text-lg font-semibold text-gray-800 mb-4">4.2.1 Carbon Credit Revenue Distribution</h4>

            <p class="text-gray-700 mb-6">
              Sustave implements a transparent revenue distribution model for carbon credit sales, ensuring all stakeholders receive their fair share.
            </p>

            <div class="distribution-chart">
              <div class="chart-visual">
                <div class="chart-bar" style="background-color: #10b981;">
                  <span>Farmer Share</span>
                  <div class="chart-value">66%</div>
                </div>
                <div class="chart-bar" style="background-color: #3b82f6;">
                  <span>Investor Share</span>
                  <div class="chart-value">22%</div>
                </div>
                <div class="chart-bar" style="background-color: #8b5cf6;">
                  <span>Platform Share</span>
                  <div class="chart-value">12%</div>
                </div>
                
                <div class="mt-6">
                  <div class="chart-legend" style="color: #10b981;">
                    <div class="w-3 h-3 rounded-full" style="background-color: #10b981;"></div>
                    <span>Compensation for sustainable practices and soil management</span>
                  </div>
                  <div class="chart-legend" style="color: #3b82f6; margin-top: 0.5rem;">
                    <div class="w-3 h-3 rounded-full" style="background-color: #3b82f6;"></div>
                    <span>Return on Investment in AcreNFT</span>
                  </div>
                  <div class="chart-legend" style="color: #8b5cf6; margin-top: 0.5rem;">
                    <div class="w-3 h-3 rounded-full" style="background-color: #8b5cf6;"></div>
                    <span>Ecosystem maintenance and development</span>
                  </div>
                </div>
              </div>
              
              <div class="chart-labels">
                <div>
                  <h4 class="font-semibold mb-2">Distribution Model Details</h4>
                  <p class="text-gray-700">
                    The 66-22-12 distribution model ensures that:
                  </p>
                  <ul class="list-disc pl-6 mt-2 space-y-1">
                    <li><span style="color: #10b981;">Farmers</span> receive the majority share as compensation for sustainable farming practices</li>
                    <li><span style="color: #3b82f6;">Investors</span> earn a predictable return on their investment (22% of carbon revenue + 8% quarterly)</li>
                    <li><span style="color: #8b5cf6;">The platform</span> receives a sustainable 12% to maintain operations and fund development</li>
                  </ul>
                </div>
                
                <div>
                  <h4 class="font-semibold mb-2">Quarterly Returns for Investors</h4>
                  <p class="text-gray-700">
                    In addition to the 22% carbon revenue share, investors receive:
                  </p>
                  <div class="mt-3">
                    <div class="font-semibold" style="color: #3b82f6;">8% Annual Return</div>
                    <div class="text-sm text-gray-600">Paid quarterly (2% per quarter)</div>
                  </div>
                </div>
              </div>
            </div>

            <h4 class="text-lg font-semibold text-gray-800 mb-4">4.2.2 Total Revenue Calculation per Acre</h4>

            <p class="text-gray-700 mb-6">
              The total revenue per acre is calculated considering both carbon credits and agricultural production:
            </p>

            <div class="highlight-box">
              <h5 class="font-semibold mb-3">Revenue Calculation Formula</h5>
              <pre class="bg-gray-800 text-green-400 p-4 rounded-lg text-sm overflow-x-auto">
-- Total Revenue per Acre
Total_Revenue = Carbon_Revenue + Harvest_Revenue

-- Carbon Revenue
Carbon_Revenue = CO₂_Reduced × Price_per_ton_CO₂
CO₂_Reduced = Hectares × CO₂_Factor × Quality_Index
  • CO₂_Factor for Moringa: 5 tons per hectare
  • Quality_Index: 0.8-1.2 (verified by IoT)
  • Price_per_ton_CO₂: $8.50 (configurable)

-- Harvest Revenue
Harvest_Revenue = Yield(kg/ha) × Market_Price
  • Moringa Yield: 1200 kg/ha (average)
  • Moringa Price: $4.2/kg (configurable)

-- Example for 1 hectare:
CO₂_Reduced = 1 ha × 5 t/ha × 1.0 = 5 tons
Carbon_Revenue = 5 t × $8.50 = $42.50
Harvest_Revenue = 1200 kg × $4.2 = $5,040
Total_Revenue = $5,082.50 per hectare per year</pre>
            </div>

            <h4 class="text-lg font-semibold text-gray-800 mb-4">4.2.3 Farmer Earnings Calculation</h4>

            <p class="text-gray-700 mb-6">
              Farmers receive 66-70% of the total revenue, depending on their specific agreement:
            </p>

            <div class="highlight-box">
              <h5 class="font-semibold mb-3">Farmer Earnings Formula</h5>
              <pre class="bg-gray-800 text-green-400 p-4 rounded-lg text-sm overflow-x-auto">
Farmer_Earnings(USD/year) = (Carbon_Revenue × 0.66) + (Harvest_Revenue × 0.70)

-- Example for 1 hectare:
Carbon_Revenue = $42.50 × 0.66 = $28.05
Harvest_Revenue = $5,040 × 0.70 = $3,528.00
Farmer_Earnings = $3,556.05 per hectare per year</pre>
            </div>
          </div>
        </div>
      </section>

      <!-- Section 5: Data Integrity -->
      <section id="data-integrity" class="section-padding bg-gray-50">
        <div class="max-w-4xl mx-auto">
          <h2 class="serif text-3xl font-bold text-gray-900 mb-8">5. Improving Data Integrity and Validation</h2>

          <!-- Validation & Constraints -->
          <div id="validation-constraints" class="mb-12">
            <h3 class="serif text-2xl font-semibold text-gray-900 mb-6">5.1 Strengthening Data Validation with Constraints and Triggers</h3>

            <h4 class="text-lg font-semibold text-gray-800 mb-4">5.1.1 Validating Farm Activities and Yields</h4>

            <p class="text-gray-700 mb-6">
              Farm activity data must be validated for realistic yield values and proper activity types to maintain data integrity.
            </p>

            <div class="highlight-box">
              <h5 class="font-semibold mb-3">Farm Activity Validation Trigger</h5>
              <pre class="bg-gray-800 text-green-400 p-4 rounded-lg text-sm overflow-x-auto">
CREATE OR REPLACE FUNCTION validate_farm_activity()
RETURNS TRIGGER AS $$
DECLARE
    farm_size DECIMAL(10,2);
    max_yield DECIMAL(10,2);
BEGIN
    -- Validate activity type
    IF NEW.activity_type NOT IN ('planting', 'harvest', 'maintenance', 'intercropping') THEN
        RAISE EXCEPTION 'Invalid farm activity type';
    END IF;
    
    -- Validate positive yield
    IF NEW.yield_kg <= 0 THEN
        RAISE EXCEPTION 'Yield must be greater than 0';
    END IF;
    
    -- Validate maximum yield (10,000 kg per hectare)
    SELECT farm_size_hectares INTO farm_size
    FROM farmers
    WHERE user_id = NEW.farmer_id;
    
    max_yield := farm_size * 10000;
    IF NEW.yield_kg > max_yield THEN
        RAISE EXCEPTION 'Yield exceeds maximum capacity (max: % kg)', max_yield;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger for validating farm activities
CREATE TRIGGER validate_farm_activity_trigger
BEFORE INSERT ON farm_activities
FOR EACH ROW
EXECUTE FUNCTION validate_farm_activity();</pre>
            </div>

            <h4 class="text-lg font-semibold text-gray-800 mb-4">5.1.2 Preventing Duplicate Carbon Credits</h4>

            <p class="text-gray-700 mb-6">
              Unique constraints prevent duplicate carbon credit generation for the same acre and time period.
            </p>

            <div class="highlight-box">
              <h5 class="font-semibold mb-3">Unique Constraint Implementation</h5>
              <pre class="bg-gray-800 text-green-400 p-4 rounded-lg text-sm overflow-x-auto">
-- Constraint to prevent duplicates in the same period
ALTER TABLE carbon_credits
ADD CONSTRAINT unique_credit_per_period UNIQUE (acre_nft_id, generation_period);</pre>
            </div>
          </div>

          <!-- Audit & Logging -->
          <div id="audit-logging" class="mb-12">
            <h3 class="serif text-2xl font-semibold text-gray-900 mb-6">5.2 Audit & Logging</h3>

            <p class="text-gray-700 mb-6">
              Comprehensive audit logging tracks all changes to critical data and administrative actions. The existing <code>audit_logs</code> and <code>admin_actions</code> tables provide a foundation for this security monitoring.
            </p>

            <div class="grid md:grid-cols-3 gap-6">
              <div class="bg-gray-50 p-6 rounded-lg">
                <h4 class="font-semibold mb-3">Configuration Changes</h4>
                <p class="text-sm text-gray-600">Track all system configuration modifications with before/after values</p>
              </div>

              <div class="bg-gray-50 p-6 rounded-lg">
                <h4 class="font-semibold mb-3">User Role Changes</h4>
                <p class="text-sm text-gray-600">Monitor privilege escalation and access control modifications</p>
              </div>

              <div class="bg-gray-50 p-6 rounded-lg">
                <h4 class="font-semibold mb-3">Tokenomic Updates</h4>
                <p class="text-sm text-gray-600">Audit changes to fee structures and reward calculations</p>
              </div>
            </div>

            <h4 class="text-lg font-semibold text-gray-800 mb-4 mt-8">5.2.1 Audit Log Implementation</h4>

            <div class="highlight-box">
              <h5 class="font-semibold mb-3">Audit Trigger Example</h5>
              <pre class="bg-gray-800 text-green-400 p-4 rounded-lg text-sm overflow-x-auto">
-- Trigger for audit logging
CREATE OR REPLACE FUNCTION audit_table()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO audit_logs (
        user_id, action, old_value, new_value, timestamp
    ) VALUES (
        current_user_id(),
        TG_OP,
        CASE TG_OP
            WHEN 'UPDATE', 'DELETE' THEN row_to_json(OLD)::TEXT
            ELSE NULL
        END,
        CASE TG_OP
            WHEN 'UPDATE', 'INSERT' THEN row_to_json(NEW)::TEXT
            ELSE NULL
        END,
        NOW()
    );
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Apply auditing to critical tables
CREATE TRIGGER audit_users_trigger
AFTER INSERT OR UPDATE OR DELETE ON users
FOR EACH ROW EXECUTE FUNCTION audit_table();

CREATE TRIGGER audit_token_balances_trigger
AFTER INSERT OR UPDATE OR DELETE ON token_balances
FOR EACH ROW EXECUTE FUNCTION audit_table();</pre>
            </div>
          </div>
        </div>
      </section>

      <!-- Conclusion -->
      <section id="conclusion" class="section-padding bg-gray-900 text-white">
        <div class="max-w-4xl mx-auto">
          <h2 class="serif text-3xl font-bold mb-8">Conclusion</h2>

          <div class="prose prose-lg max-w-none text-gray-300">
            <p class="text-xl mb-6 leading-relaxed">
              The proposed enhancements to the Sustave platform's PostgreSQL database architecture represent a comprehensive approach to building a secure, scalable, and reliable foundation for sustainable agriculture finance.
            </p>

            <div class="grid md:grid-cols-2 gap-8 my-8">
              <div>
                <h3 class="text-xl font-semibold mb-4 text-white">Security Foundation</h3>
                <p class="text-gray-300">
                  The hybrid authorization model combining RLS with wallet-centric access control provides robust data isolation while maintaining flexibility for complex access scenarios across admin, investor, and farmer roles.
                </p>
              </div>

              <div>
                <h3 class="text-xl font-semibold mb-4 text-white">Performance Excellence</h3>
                <p class="text-gray-300">
                  Strategic indexing and optimized token transfer processing ensure the platform can handle high transaction volumes while maintaining responsive performance for all users.
                </p>
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-8 my-8">
              <div>
                <h3 class="text-xl font-semibold mb-4 text-white">Transparent Profit Distribution</h3>
                <p class="text-gray-300">
                  The 66-22-12 revenue model for carbon credits creates a sustainable ecosystem where farmers, investors, and the platform all benefit fairly from the value created.
                </p>
              </div>

              <div>
                <h3 class="text-xl font-semibold mb-4 text-white">Clear Acre Lifecycle</h3>
                <p class="text-gray-300">
                  The defined acre lifecycle states and retirement process ensure proper management of tokenized land assets from creation to retirement.
                </p>
              </div>
            </div>

            <p class="text-gray-300 mb-6">
              The refinements to the data model, particularly in wallet integration, carbon credit lifecycle management, and profit distribution, create a more streamlined and transparent architecture. Enhanced data validation and comprehensive audit logging ensure data integrity and regulatory compliance.
            </p>

            <p class="text-gray-300">
              Together, these improvements position the Sustave platform for sustainable growth while maintaining the security, performance, and transparency that users expect from a modern agricultural finance platform that truly connects farmers with global investors.
            </p>
          </div>
        </div>
      </section>
    </main>

    <script>
        // Smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                    
                    // Close TOC on mobile after clicking a link
                    if (window.innerWidth <= 1024) {
                        document.getElementById('toc').classList.remove('open');
                    }
                }
            });
        });

        // Mobile TOC toggle
        const tocToggle = document.createElement('button');
        tocToggle.innerHTML = '<i class="fas fa-bars"></i>';
        tocToggle.className = 'fixed top-4 left-4 z-50 bg-white p-3 rounded-lg shadow-lg lg:hidden';
        tocToggle.onclick = function(e) {
            e.stopPropagation();
            document.getElementById('toc').classList.toggle('open');
        };
        document.body.appendChild(tocToggle);

        // Close TOC when clicking outside on mobile
        document.addEventListener('click', function(e) {
            const toc = document.getElementById('toc');
            if (window.innerWidth <= 1024 && toc.classList.contains('open') && 
                !toc.contains(e.target) && e.target !== tocToggle) {
                toc.classList.remove('open');
            }
        });

        // Reset TOC state on desktop
        window.addEventListener('resize', function() {
            const toc = document.getElementById('toc');
            if (window.innerWidth > 1024) {
                toc.classList.remove('open');
            }
        });
    </script>
  </body>

</html>
